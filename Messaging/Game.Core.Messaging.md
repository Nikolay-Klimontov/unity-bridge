# Messaging overview
Связывает разные системы между собой за счёт пересылки сообщений, не нужно думать над связанностью кода.

Есть какой-никакой контроль типов сообщений и данных, так что в ногу выстрелить сложнее. Получите то же что и отправлено, туда же чем и подписывались.

Дёргать MessageSystem за методы чтобы получить доступ до шин можно(но не обязательно) в любом участке кода.
Если объект существует с самого старта игры и должен что-то делать, то подписываться лучше в конструкторе.

У шины дёргать Subscribe для подписки (не забываем сохранять токены подписки чтобы потом отписаться) и Unsubscribe для отписки, Publish чтобы разослать ваше событие всем заинтересованным.

# Внешний интерфейс
 
## [Message System](MessageSystem.cs)
Общая точка доступа до шин сообщений, Lazy-синглтон.
Пока что содержит единственную шину для оправки/получения сообщений

## [Прототипы классов сообщений](./BasicEvent.cs)
Базовые классы для всех сообщений, передаваемых через EventBus
Обязательно содержат `уникальный идентификатор сообщения (GUID)` и `отправителя`

### Класс `BasicEvent`
Общий предок всех сообщений, передаваемых через шину. Содержит GUID и отправителя. 
Подходит в качестве базового класса если сообщение не должно содержать данных:

- что-то закончилось или началось
- подтверждение данных
- уведомления об ошибках (LoginFailed/NetworkConnectionLost  и т.п.)


### Класс `DataEvent<TPayload>`
Общий предок для всех сообщений с данными. Данные **строго типизированы**, никаких конвертаций 
Подходит для передачи данных между системами:

- Начат поиск комнаты с друзьями
- Матчмейкинг вернул указание подключиться к найденной комнате
- Присоединился новый игрок (содержит GUID игрока для запроса внешнего вида, например)

Пример использования в пользовательском коде
```
    namespace GameEvents
    {
        //To inform various system about 
        public class ConnectionLost : BasicEvent
        {
            public ConnectionLost(object sender) : base (sender) 
            {}
        }

        .....
        //When need to instantiate and inform player about new member in room
        public class NewPlayerJoined : DataEvent<PlayerData>
        {
            public NewPlayerJoined(object sender, PlayerData payload) : base(sender, payload) 
            {}
        }
    }
```


## [Общий интерфейс шин](./IEventBus.cs)
Точка расширения, предоставляет единообразный интерфейс использования всех шин сообщений
 
### Контракт:
#### Подписка на заданный тип сообщения

- Добаляет нового подписчика в список рассылки
- Принимает обработчик для данного типа событий
- Возвращает токен на подписку
- Прототип: `SubscriptionToken Subscribe<TEvent>(Action<TEvent> handler)`

Пример использования в пользовательском коде:
```
    // Declare event type
    MyEventType : BasicEvent {...}
    ...
    // Somwhere in your code
    // Set handler directly (i.e. if you need to know type of event)
    var mySub = Bus.Subscribe<MyEventType>(MyHandler);
    
    // alternatively you can bind Lambda-expression
    var mySub = Bus.Subscribe((MyEventType e)=>
        {
            MyFunction(e.payload);
        });
```
#### Отписка от сообщений
- Удаляет подписчика из списка рассылки
- Принимает токен подписки, выданный ранее
- Прототип: `void Unsubscribe(SubscriptionToken token)`
    
Пример использования в прользовательском коде:
```
    public class MyClass
    {
        ...
        public void OnDestroy()
        {
            Bus.Unsubscribe(mySub);
        }
    }
```
#### Публикация сообщения. 
- Разослать сообщение всем подписчикам
- Принимает объект-наследник типа BasicEvent
- Прототип: `void Publish< TEvent >(TEvent e)`

Пример использования в прользовательском коде:
```
    ...
    Bus.Publish(new MyEvenentType(sender));
    ...
```

## [SubscriptionToken](./SubscriptionToken.cs)
Хранит сопоставление типа сообщения и уникального идентификатора подписки для упрощения поиска. С его помощью можно отписаться от приёма сообщений.
> При уничтожении токена происходит автоматическая отписка от получения, будьте внимательны!

# Внутренности
## [Синхронная шина сообщений](./EventBus.cs)
Содержит базовую реализацию шины с синхронной рассылкой. Рассылка происходит в `Publish(...)`

## [ISubscription](./ISubscription.cs)
Интерфейс для упрощения рассылки событий по подписчикам.

## [Subscription](./Subscription.cs)
Хранит обработчик события для зарегистрированного подписчика, автоматически приводит событие к исходному типу при вызове обработчика.
